---
title: "Knowledge & Motivation Instrument Correlations"
execute:
  echo: true
  warning: false
format:
  html: 
    grid:
      sidebar-width: 220px
      body-width: 1200px
      margin-width: 170px
      gutter-width: 1.0rem
  hugo-md:
    include: true
    html-math-method: mathjax
    output-file: cor_hugo.md
  pdf: 
    documentclass: article
    papersize: letter
    toc: false
    fontsize: 10pt
    linestretch: 1.5
    geometry:
      - top=.5in     
      - bottom=.5in  
      - left=.5in    
      - right=.25in  
      - heightrounded
---

# Knowledge & Motivation Instrument Correlations


This notebook explores data from a multi-survey study investigating the relationships between sustainable behaviors, knowledge, and attitudes. The study involved participants completing five different surveys, each designed to measure different aspects of these constructs. This analysis focuses on understanding these relationships, with a particular emphasis on the connection between knowledge and motivation.


## Data and Survey Instruments

The dataset combines responses from five different surveys into a single data frame, structured such that each row represents a participant, and each column represents a response, or a derived score. The five underlying surveys are:

*   **Energy Literacy Survey (ELS01-ELS08):**  Assesses participants' knowledge of energy concepts through multiple-choice questions. 
*   **Attari Energy Survey - Part 1:**
    *   **Perceived Difficulty Items (ATT01-ATT15):** Measures how easy or hard participants would find it to adopt energy-saving behaviors, using a rating scale.
    *   **Numeracy Questions (ATT16-ATT18):** Assesses numerical literacy through probability questions requiring numeric answers.
*   **Attari Energy Survey - Part 2:**
    *   **Relative Energy Usage (ATT19-ATT27):**  Asks participants to estimate the relative energy usage of various devices compared to a 100-Watt bulb, using a numeric response format.
    *   **Relative Energy Savings (ATT28-ATT33):** Asks participants to estimate the relative energy savings of various actions compared to turning off a 100-Watt bulb, using a numeric response format.
*   **Recycling Study Questions (RS01-RS06):** Assesses participantsâ€™ attitudes towards the environment and politics.



# Exploratory Analysis of Multi-Survey Study on Sustainable Behaviors

This notebook presents an exploratory analysis of response data from a multi-survey study focused on understanding the relationships between sustainable behaviors, knowledge, and attitudes. The study involved participants completing five different surveys, each designed to measure different aspects of these constructs. This analysis aims to examine the relationships between the different survey instruments, with a particular focus on the connection between knowledge and motivation.

## Data Loading and Preparation



This code block loads the required R libraries for data analysis and visualization. It then reads the survey response data from two RDS files, `draw.rds` and `dinst.rds`, which presumably contain responses from different groups or conditions. Finally, it combines subsets of the data corresponding to different surveys (Attari Energy Survey Part 1 and Part 2, Energy Literacy Survey, and Recycling Study) into separate data frames.


```{r}
pacman::p_load(dplyr,purrr,tidyr,here, haven,tibble,ggplot2,ggh4x,lme4,knitr,kableExtra,gt,pander,flextable,ggh4x,psych,corrplot,factoextra)
options(digits=2, scipen=999, dplyr.summarise.inform=FALSE)

library(gridExtra)
library(factoextra)
library(mgcv)
library(lavaan)
library(CCA)
library(qgraph)
library(rpart)
library(rpart.plot)
library(mclust)
library(tidyLPA)

select = dplyr::select

source(here("scripts","survey_functions.R"))

# Load data from RDS files
draw <- readRDS(here("data", "draw.rds"))
dinst <- readRDS(here("data", "dinst.rds"))

# Combine data from different sources
aes1 <- draw |> select(id, ATT01:ATT18)
aes2 <- dinst |> select(id, ATT01:ATT18)
aes_combined <- bind_rows(aes1, aes2)

att_useSave <- draw |> select(id, ATT19:ATT33)
att_useSave2 <- dinst |> select(id, ATT19:ATT33)
att2_combined <- bind_rows(att_useSave, att_useSave2)

els1 <- draw |> select(id, ELS01:ELS08)
els2 <- dinst |> select(id, ELS01:ELS08)
els <- bind_rows(els1, els2)

rs1 <- draw |> select(id, RS01:RS06)
rs2 <- dinst |> select(id, RS01:RS06)
rs <- bind_rows(rs1, rs2)

```









This code block processes the raw survey responses to generate meaningful scores for each participant. It utilizes custom functions (`analyze_attari_survey_part1`, `analyze_attari_survey`, `analyze_els_survey`, `analyze_recycling_survey`) to calculate scores based on the specific coding schemes of each survey. These individual scores are then combined into a single data frame `combined_scores`, where each row represents a participant and each column represents a score from one of the surveys. Finally, the columns are renamed for better readability.


## Data Summarization and Scoring

```{r}
# Analyze and score each survey
attari1 <- analyze_attari_survey_part1(aes_combined)
attari2_scores <- analyze_attari_survey(att2_combined)
els_scores <- analyze_els_survey(els)
rs_scores <- analyze_recycling_survey(rs)

# Combine all scores into one dataframe
combined_scores <- attari1 %>%
  left_join(attari2_scores, by = "id") %>%
  left_join(els_scores, by = "id") %>%
  left_join(rs_scores, by = "id")

# Rename columns for clarity
names(combined_scores) <- c(
  "id", "perceived_difficulty", "numeracy",
  "energy_use", "energy_save",
  "els_accuracy", "els_score",
  "env_attitude", "env_attitude_z",
  "pol_conservatism", "pol_conservatism_z"
)
```




## Preliminary Data Exploration

```{r}
# Preview the combined scores data
combined_scores |> head(5) |> kable() |> kable_styling("striped", full_width = F)
```

This code provides a glimpse into the structure and content of the `combined_scores` data frame.

| id  | perceived\_difficulty | numeracy | energy\_use | energy\_save | els\_accuracy | els\_score | env\_attitude | env\_attitude\_z |
| :-- | :-------------------- | :------- | :---------- | :----------- | :------------ | :-------- | :------------ | :--------------- |
| 1   | 0.61                  | 1.5      | 1.101       | 1.01         | 6             | 0.74      | 3.2           | -0.43            |
| 2   | -0.45                 | 1.5      | 0.137       | -0.46        | 5             | 0.20      | 3.5           | -0.11            |
| 3   | 2.09                  | -2.0     | -1.440      | 0.70         | 4             | -0.33     | 3.0           | -0.76            |
| 4   | -0.69                 | -1.3     | 1.346       | 2.16         | 2             | -1.40     | 3.8           | 0.22             |
| 5   | 0.91                  | 1.5      | 0.075       | -0.52        | 3             | -0.87     | 3.8           | 0.22             |

This table shows the first five rows of the `combined_scores` data frame, providing a snapshot of the calculated scores for each participant across the different measures. The scores include perceived difficulty, numeracy, energy use, energy save, ELS accuracy, ELS score, environmental attitude, and the z-score of environmental attitude.

## Descriptive Statistics

```{r}
#| fig-width: 10
#| fig-height: 8

# Histograms of key variables
key_vars <- combined_scores %>% 
  select(perceived_difficulty, numeracy, energy_use, energy_save, els_score, env_attitude, pol_conservatism)

# Melt the data for plotting
melted_vars <- key_vars %>%
  gather(key = "variable", value = "value")

# Plot histograms
ggplot(melted_vars, aes(x = value)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "black") +
  facet_wrap(~variable, scales = "free") +
  theme_minimal() +
  labs(title = "Distribution of Key Variables", x = "Value", y = "Frequency")
```



## Correlation Analysis

```{r}

# Select relevant variables
cor_vars <- combined_scores %>%
  select(numeracy, energy_use, energy_save, els_score,
         perceived_difficulty, env_attitude, pol_conservatism)

# Compute correlation matrix
cor_matrix <- cor(cor_vars, use = "pairwise.complete.obs")

# Visualize correlation matrix
corrplot::corrplot(cor_matrix, 
                   method = "color", 
                   addCoef.col = "black", 
                   type = "upper",
                   tl.col  = "black",
                   tl.srt  = 45,
                   diag    = FALSE)




```


## Cluster Analysis

```{r}
# Prepare data for clustering (select relevant variables and scale)
cluster_data <- combined_scores %>%
  select(perceived_difficulty, numeracy, energy_use, energy_save, els_score, env_attitude_z, pol_conservatism_z) %>%
  na.omit() %>%
  scale()

# Determine optimal number of clusters using the elbow method
fviz_nbclust(cluster_data, kmeans, method = "wss") +
  labs(title = "Elbow Method for Optimal k", x = "Number of Clusters k")
```

This code performs a cluster analysis to identify groups of participants with similar profiles across the measured variables. It first prepares the data by selecting the relevant variables, removing rows with missing values, and scaling the data. Then, it uses the elbow method to determine the optimal number of clusters.

```{r}
# Perform k-means clustering (e.g., with 3 clusters)
set.seed(123)
km_result <- kmeans(cluster_data, centers = 3, nstart = 25)

# Visualize the clusters
fviz_cluster(km_result,
  data = cluster_data,
  geom = "point",
  ellipse.type = "convex",
  ggtheme = theme_bw()
) +
  labs(title = "K-means Clustering of Subjects")
```

This code performs k-means clustering with 3 clusters (as suggested by the elbow method) and visualizes the clusters using a scatter plot.

### Elbow Method for Optimal k

The elbow method suggests that the optimal number of clusters is where the decrease in the within-cluster sum of squares starts to slow down, forming an "elbow". In the generated plot, the elbow appears to be around 3 or 4 clusters. We will proceed with 3 clusters for this analysis, but further investigation with 4 clusters might be warranted.

### K-means Clustering of Subjects

The scatter plot shows the results of the k-means clustering with 3 clusters. Each point represents a participant, and the color indicates their assigned cluster. The ellipses represent the convex hulls of each cluster. The plot suggests some degree of separation between the clusters, although there is also some overlap.

## Factor Analysis

```{r}
# Scree plot to determine the number of factors
fa_data <- combined_scores %>%
  select(perceived_difficulty, numeracy, energy_use, energy_save, els_score, env_attitude_z, pol_conservatism_z) %>%
  na.omit()
scree(fa_data)
```

This code performs a factor analysis to explore the underlying structure of the measured variables. It first prepares the data by selecting the relevant variables and removing rows with missing values. Then, it generates a scree plot to help determine the number of factors to extract.

```{r}
# Perform factor analysis with, e.g., 2 factors
fa_result <- fa(fa_data, nfactors = 2, rotate = "varimax")
print(fa_result, cut = 0.3, sort = TRUE)
```

This code performs the factor analysis with 2 factors and prints the results, showing the factor loadings for each variable.

### Scree Plot

The scree plot suggests that 2 or 3 factors might be appropriate, as the eigenvalues drop substantially after the second and third factors.

### Factor Analysis Results

The factor analysis results with 2 factors show that:

*   **Factor 1** is primarily associated with `env_attitude_z` and `pol_conservatism_z`, suggesting a factor related to environmental and political attitudes.
*   **Factor 2** is primarily associated with `energy_use`, `energy_save`, `numeracy`, and `els_score`, suggesting a factor related to energy knowledge and behavior.
*   `perceived_difficulty` loads negatively on Factor 2, indicating that individuals with higher energy knowledge and better energy-saving behaviors tend to perceive these behaviors as less difficult.

## Regression Analysis

```{r}
# Model predicting ELS from motivation, controlling for other knowledge scores
model_els_enhanced <- lm(els_score ~ perceived_difficulty + env_attitude_z + pol_conservatism_z +
  numeracy + energy_use + energy_save, data = combined_scores)
summary(model_els_enhanced)
```

This code performs a linear regression analysis to examine the relationship between energy literacy (ELS) and motivation, while controlling for other knowledge scores.

### Regression Results

The regression results show that:

*   `env_attitude_z` is a significant positive predictor of ELS, indicating that individuals with more pro-environmental attitudes tend to have higher energy literacy.
*   `numeracy`, `energy_use`, and `energy_save` are also significant positive predictors of ELS, suggesting that individuals with higher numeracy skills and those who are more accurate in their estimations of energy use and savings tend to have higher energy literacy.

#### Mixed Effects Regression

Finally, we can examine a regression where a clustering variable is treated as a random effect.

```{r}
#| eval: false
#| include: false
# Mixed Effects Model to Account for Potential Group-Level Effects
mixed_model <- lmer(els_score ~ env_attitude + perceived_difficulty +
                      (1 | id), data = combined_scores)
summary (mixed_model)
```


## Interaction Effects in Regression

```{r}
# Example: Interaction between environmental attitude and perceived difficulty on ELS
model_interaction <- lm(els_score ~ perceived_difficulty * env_attitude_z, data = combined_scores)
summary(model_interaction)

# Visualize the interaction (example)
ggplot(combined_scores, aes(x = perceived_difficulty, y = els_score, color = env_attitude_z)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_gradient(low = "blue", high = "red") +
  labs(
    title = "Interaction of Perceived Difficulty and Environmental Attitude on ELS",
    x = "Perceived Difficulty",
    y = "Energy Literacy Score"
  ) +
  theme_minimal()
```

This code explores the potential interaction effect between environmental attitude and perceived difficulty on ELS using a linear regression model. It also visualizes the interaction using a scatter plot with a regression line for each level of environmental attitude.




### Interaction Results

The regression results do not show a significant interaction effect between perceived difficulty and environmental attitude on ELS. The visualization also suggests that the relationship between perceived difficulty and ELS does not vary substantially across different levels of environmental attitude.

## Enhanced Correlation Plot

```{r}

combined_df <- attari1 %>%
  full_join(attari2_scores, by = "id") %>%
  full_join(els_scores,       by = "id") %>%
  full_join(rs_scores,        by = "id")

# 1. Enhanced Correlation Plot
cor_matrix <- combined_df %>%
  select(numeracy_score, relative_energy_use_score,
         relative_energy_save_score, els,
         perceived_difficulty_score, env_attitude,
         pol_conservatism_z) %>%
  cor(use = "pairwise.complete.obs")
corrplot(cor_matrix, method = "color", type = "upper", addCoef.col = "black", tl.col = "black", tl.srt = 45, diag = FALSE, col = colorRampPalette(c("#6D9EC1", "white", "#E46726"))(200))
```

This generates a visually informative correlation plot.

### Correlation Plot Interpretation

The correlation plot reveals several interesting patterns:

*   **Positive correlations** among knowledge measures (numeracy, energy use, energy save, and ELS).
*   **Negative correlations** between perceived difficulty and knowledge measures.
*   **Positive correlation** between environmental attitude and ELS.
*   **Negative correlation** between political conservatism and environmental attitude.

## Knowledge Profile Clustering

```{r}
# 2. Knowledge Profile Clustering
# Standardize knowledge variables
knowledge_vars <- combined_df %>%
  select(numeracy_score, relative_energy_use_score,
         relative_energy_save_score, els) %>%
  scale()

# Determine optimal number of clusters
set.seed(123)
wss <- sapply(1:10, function(k) {
  kmeans(knowledge_vars, centers = k)$tot.withinss
})

# Perform k-means clustering
k <- 3 # Based on elbow plot inspection
clusters <- kmeans(knowledge_vars, centers = k)

# Add cluster membership to data
combined_df$knowledge_cluster <- as.factor(clusters$cluster)

# Visualize clusters
pca_result <- prcomp(knowledge_vars)
cluster_df <- data.frame(
  PC1 = pca_result$x[, 1],
  PC2 = pca_result$x[, 2],
  Cluster = combined_df$knowledge_cluster
)

# Create cluster visualization
p_clusters <- ggplot(cluster_df, aes(x = PC1, y = PC2, color = Cluster)) +
  geom_point(alpha = 0.6) +
  stat_ellipse(level = 0.95) +
  theme_minimal() +
  labs(
    title = "Knowledge Profiles Clustering",
    x = "First Principal Component",
    y = "Second Principal Component"
  )
p_clusters
```

The regression results do not show a significant interaction effect between perceived difficulty and environmental attitude on ELS. The visualization also suggests that the relationship between perceived difficulty and ELS does not vary substantially across different levels of environmental attitude.


## Knowledge-Motivation Interaction Analysis

```{r}
# 4. Knowledge-Motivation Interaction Analysis
interaction_model <- lm(els ~ env_attitude * perceived_difficulty_score +
  numeracy_score, data = combined_df)
summary(interaction_model)
```

The regression results do not show a significant interaction effect between environmental attitude and perceived difficulty in predicting ELS.



### Interaction Analysis Results

The regression results do not show a significant interaction effect between environmental attitude and perceived difficulty in predicting ELS.

## Cluster Profile Analysis

```{r}
# Cluster profile analysis
cluster_profiles <- combined_df %>%
  group_by(knowledge_cluster) %>%
  summarise(
    mean_numeracy = mean(numeracy_score, na.rm = TRUE),
    mean_energy_use = mean(relative_energy_use_score, na.rm = TRUE),
    mean_energy_save = mean(relative_energy_save_score, na.rm = TRUE),
    mean_els = mean(els, na.rm = TRUE),
    mean_env_attitude = mean(env_attitude, na.rm = TRUE),
    mean_difficulty = mean(perceived_difficulty_score, na.rm = TRUE),
    n = n()
  )
print(cluster_profiles)
```

This code calculates the mean scores on each variable for each of the three knowledge clusters identified earlier.

### Cluster Profile Analysis Results

The table shows the mean scores for each cluster on the knowledge and motivation variables. This allows for a detailed comparison of the profiles of each cluster. For example, Cluster 1 has below average scores on all knowledge and motivation measures, while Cluster 3 has above average scores on those same measures.

## K-means Clustering on Knowledge and Motivation Variables

```{r}
# Example: K-means clustering on knowledge + motivation
# Subset your knowledge & motivation columns
cluster_data <- combined_df %>%
  select(numeracy_score, relative_energy_use_score, relative_energy_save_score,
         els, perceived_difficulty_score, env_attitude, pol_conservatism) %>%
  na.omit()

# Scale them
cluster_data_scaled <- scale(cluster_data)

# Decide on number of clusters (e.g. 2-5) use e.g. Elbow method
fviz_nbclust(cluster_data_scaled, kmeans, method = "wss")
```

The elbow method plot suggests 3 clusters is a reasonable choice.


```{r}
# Suppose we choose 3 clusters as a demonstration
set.seed(123)
km_result <- kmeans(cluster_data_scaled, centers = 3, nstart = 25)

# Add cluster membership back into the original data
cluster_data$cluster <- factor(km_result$cluster)

# Visualize clusters in 2D (using PCA behind the scenes)
fviz_cluster(km_result,
             data = cluster_data_scaled,
             geom = "point", ellipse.type = "convex") +
  theme_minimal() +
  labs(title = "K-means Clusters of Knowledge & Motivation Variables")
```

This code performs the k-means clustering with 3 clusters and visualizes the results using a scatter plot.

### Clustering Results

The elbow method suggests that 3 clusters might be appropriate. The scatter plot shows the three clusters based on the combined knowledge and motivation variables.

## Mediation Analysis

```{r}
# Example mediation: knowledge -> perceived_difficulty -> env_attitude
model_mediation <- '
  # direct effect
  env_attitude ~ c*els
  # mediator
  perceived_difficulty_score ~ a*els
  env_attitude ~ b*perceived_difficulty_score
  # indirect effect
  ab := a*b
  # total effect
  total := c + (a*b)
'
fit_mediation <- sem(model_mediation, data = combined_df, missing = "fiml")
summary(fit_mediation, fit.measures = TRUE, standardized = TRUE, rsquare = TRUE)
tidySEM::graph_sem(fit_mediation)
semPlot::semPaths(fit_mediation,layout="tree2",residual=TRUE,whatLabels="est", nCharNodes = 9)
```

This code performs a mediation analysis to test whether perceived difficulty mediates the relationship between knowledge (ELS) and environmental attitude.

# Modeling the Relationship between Knowledge and Motivation using Structural Equation Modeling

```{r}
# Hypothetical model:
#   - latent Knowledge from numeracy, energy_use, energy_save, els_score
#   - latent Motivation from env_attitude, perceived_difficulty
#   - regression: Knowledge ~ Motivation

sem_model <- '
  Knowledge =~ numeracy + energy_use + energy_save + els_score
  Motivation =~ env_attitude + perceived_difficulty
  Knowledge ~ Motivation
'
fit_sem <- sem(sem_model, data = combined_scores, missing = "fiml")  # handle missing if needed
summary(fit_sem, fit.measures = TRUE, standardized = TRUE)
tidySEM::graph_sem(fit_sem)
semPlot::semPaths(fit_sem,layout="tree2",residual=TRUE,whatLabels="est", nCharNodes = 9)

```

### Mediation Analysis Results

The mediation analysis results suggest that perceived difficulty partially mediates the relationship between ELS and environmental attitude. The indirect effect is significant, indicating that higher ELS is associated with lower perceived difficulty, which in turn is associated with a more positive environmental attitude.

## Knowledge-Motivation Profiles by Cluster

```{r}
# Create composite knowledge score
combined_scores$composite_knowledge <- rowMeans(combined_scores[, c("numeracy", "energy_use", "energy_save", "els_score")])

# Ensure cluster column exists
combined_scores$cluster <- as.factor(cluster_data$cluster)

# Create standardized scores for profile analysis
profile_data <- combined_scores %>%
  select(id, cluster, numeracy, energy_use, energy_save,
         els_score, env_attitude, perceived_difficulty) %>%
  gather(measure, value, -id, -cluster) %>%
  group_by(measure) %>%
  mutate(z_score = scale(value)[, 1]) %>%
  ungroup()

# Create profile plot
ggplot(profile_data, aes(x = measure, y = z_score, color = cluster, group = cluster)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  stat_summary(fun = mean, geom = "point", size = 3) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(
    title = "Knowledge-Motivation Profiles by Cluster",
    x = "Measure", y = "Standardized Score"
  )
```


The profile plot shows distinct patterns for each cluster:

*   **Cluster 1:** Below average on all knowledge measures, above average on perceived difficulty, and average on environmental attitude.
*   **Cluster 2:** Above average on knowledge measures, below average on perceived difficulty, and average on environmental attitude.
*   **Cluster 3:** Average on knowledge measures, below average on perceived difficulty, and above average on environmental attitude.


```{r}

# Combine key measures into correlation matrix
key_measures <- combined_scores %>%
  select(
    # Knowledge measures
    numeracy, energy_use, energy_save, els_score,
    # Motivation/attitude measures
    env_attitude, perceived_difficulty, pol_conservatism
  ) %>%
  na.omit()

# Compute and visualize correlation matrix
cor_matrix <- cor(key_measures, use = "pairwise.complete.obs")
corrplot(cor_matrix,
         method = "color",
         type = "upper",
         addCoef.col = "black",
         tl.col = "black",
         tl.srt = 45,
         diag = FALSE,
         col = colorRampPalette(c("#6D9EC1", "white", "#E46726"))(200)
)


# 2. Factor Analysis to examine underlying structure
fa_results <- fa(key_measures, nfactors = 2, rotate = "varimax")
print (fa_results, cut = 0.3, sort = TRUE)
```



## Canonical Correlation Analysis (CCA)

```{r}
# 2. Canonical Correlation Analysis between Knowledge and Motivation Sets
# Prepare matrices
knowledge_vars <- combined_scores %>% select(numeracy, energy_use, energy_save, els_score) %>%
  as.matrix()
motivation_vars <- combined_scores %>%
  select(env_attitude, perceived_difficulty, pol_conservatism) %>%
  as.matrix()

# Perform CCA
cc_result <- cancor(knowledge_vars, motivation_vars)

# 3. Network Analysis to Visualize Variable Relationships
# Create correlation matrix
cor_matrix <- cor(combined_scores %>%
                    select(numeracy, energy_use, energy_save, els_score,
                           env_attitude, perceived_difficulty, pol_conservatism),
                  use = "pairwise.complete.obs")

# Create network plot
qgraph(cor_matrix,
       layout = "spring",
       groups = list(Knowledge = 1:4, Motivation = 5:7),
       color = c(rep("lightblue", 4), rep("lightgreen", 3)))
```

This performs a CCA to explore the relationships between the set of knowledge variables and the set of motivation variables and a network analysis to visualize variable relationships.

### CCA Results

The CCA identifies canonical variates that maximally correlate the knowledge and motivation sets. The first canonical correlation is 0.418, suggesting a moderate relationship between the two sets of variables.

### Network Analysis Results

The network plot visually represents the correlations between the variables, with node colors indicating whether a variable belongs to the knowledge or motivation set. The plot provides a clear visualization of the relationships between the different constructs.

## Structural Equation Modeling (SEM)

```{r}
# 5. Structural Equation Model for Path Analysis
# Define model
model <- "
  # Measurement model
  knowledge =~ numeracy + energy_use + energy_save +els_score
  motivation =~ env_attitude + perceived_difficulty + pol_conservatism

  # Structural model
  knowledge ~ motivation
  motivation ~ knowledge
"

# Fit model
fit <- sem(model, data = combined_scores)
summary(fit, standardized = TRUE, fit.measures = TRUE)

tidySEM::graph_sem(fit)
semPlot::semPaths(fit,layout="tree2",residual=TRUE,whatLabels="est", nCharNodes = 9)

```

This code fits a structural equation model to test a path model where motivation predicts knowledge.

### SEM Results

The SEM results provide support for the hypothesized model, with a good model fit and a significant path from motivation to knowledge. The standardized path coefficient suggests that a one-unit increase in motivation is associated with a 0.577-unit increase in knowledge.

## Classification Tree

```{r}
# 6. Classification Tree for Predicting Knowledge Levels - rpart functions
# Create binary knowledge indicator (high/low) based on median split
combined_scores$knowledge_level <- factor(ifelse(combined_scores$composite_knowledge >
  median(combined_scores$composite_knowledge, na.rm = TRUE),
"High", "Low"
))

# Fit tree
tree_model <- rpart(knowledge_level ~ env_attitude + perceived_difficulty +
  pol_conservatism, data = combined_scores)

# Plot tree
rpart.plot(tree_model, extra = 1)
```

This code creates a classification tree to predict whether a participant has high or low knowledge based on their environmental attitude, perceived difficulty, and political conservatism.

### Classification Tree Results

The classification tree provides a set of rules for classifying participants into high or low knowledge groups based on their scores on the predictor variables. For instance, participants with a `pol_conservatism` score less than 1.8 are classified as 'High' knowledge, while those with `pol_conservatism` greater than 1.8 and `perceived_difficulty` less than 0.56 are classified as 'Low' knowledge.

## Latent Profile Analysis (LPA)

```{r}
# Example LPA (using tidyLPA)
lpa_data <- combined_scores %>%
  select(numeracy, energy_use, energy_save, els_score, env_attitude_z, perceived_difficulty) %>%
  na.omit() |>
  # convert all to numeric
  mutate_all(as.numeric)

lpa_results <- lpa_data %>%
  estimate_profiles(n_profiles = 1:5) %>% # Estimate models with 1-5 profiles
  compare_solutions(statistics = c("AIC", "BIC"))

plot(lpa_results)
```

This code performs a latent profile analysis (LPA) to identify distinct subgroups of participants based on their patterns of responses across the knowledge and motivation variables.

### LPA Results

The BIC suggests that a model with 8 profiles fits the data best. The plot shows the BIC values for models with 1 to 5 profiles.

## Factor Analysis with Combined Variables

```{r}
# Combine all items into a single dataframe
all_items <- full_join(aes_combined, att2_combined, by = "id") %>%
  full_join(els, by = "id") %>%
  full_join(rs, by = "id")

# Select only item columns for factor analysis
item_columns <- setdiff(names(all_items), "id")
item_data <- all_items[, item_columns]

# Perform factor analysis
fa_items <- fa(item_data, nfactors = 5, rotate = "varimax") # Adjust nfactors as needed
print(fa_items, cut = 0.3, sort = TRUE)
```

This performs a factor analysis on all individual survey items to explore the underlying structure of the data.

### Factor Analysis Results

The factor analysis suggests a five-factor solution. The items load onto the factors in a way that is generally consistent with the hypothesized constructs, although there are some cross-loadings.

## Knowledge-Motivation Relationship Analyses

### Bivariate Correlation

```{r}

# Create composite scores for knowledge and motivation
combined_scores <- combined_scores %>%
  mutate(
    knowledge = rowMeans(select(., numeracy, energy_use, energy_save, els_score), na.rm = TRUE),
    motivation = rowMeans(select(., env_attitude, -perceived_difficulty, -pol_conservatism), na.rm = TRUE)
  )

# 3a. Bivariate Correlation
with(combined_scores, cor.test(knowledge, motivation))
```

This code calculates the bivariate correlation between the composite knowledge and motivation scores.

#### Bivariate Correlation Results

The correlation between knowledge and motivation is -0.018, which is not statistically significant (p = 0.7). This suggests a very weak, negative linear relationship between overall knowledge and motivation in this sample.

### Hierarchical Regression

```{r}
# 3b. Hierarchical Regression
model <- lm(knowledge ~ motivation + pol_conservatism_z + cluster,
  data = combined_scores
)
summary(model)
```

This code performs a hierarchical regression analysis to examine the relationship between knowledge and motivation, controlling for political conservatism and cluster membership.

#### Hierarchical Regression Results

The regression results show that:

*   Motivation is not a significant predictor of knowledge when controlling for political conservatism and cluster membership.
*   Political conservatism is not a significant predictor of knowledge.
*   Cluster membership is a significant predictor of knowledge, with Clusters 2 and 3 having significantly higher knowledge scores than Cluster 1.

### Path Analysis

```{r}
# 3c. Path Analysis
path_model <- "
  motivation ~ a * knowledge
  els_score ~ b * motivation + c * knowledge
  indirect := a * b
  total := c + indirect
"
fit <- sem(path_model, data = combined_scores)
summary(fit, standardized = TRUE)
tidySEM::graph_sem(fit)
semPlot::semPaths(fit)

```

This code fits a path model to test the indirect effect of knowledge on ELS through motivation.

#### Path Analysis Results

The path analysis results show that:

*   The direct effect of knowledge on ELS is significant and positive (c = 0.707).
*   The direct effect of motivation on ELS is not significant (b = 0.036).
*   The indirect effect of knowledge on ELS through motivation is not significant (a\*b = -0.001).

### Cluster Validation by Motivation-Knowledge Profiles

```{r}
# 4. Cluster Validation by Motivation-Knowledge Profiles
ggplot(combined_scores, aes(x = knowledge, y = motivation, color = cluster)) +
  geom_point(alpha = 0.6) +
  stat_ellipse(level = 0.95) +
  labs(
    title = "Knowledge-Motivation Profiles by Cluster",
    x = "Standardized Knowledge Composite",
    y = "Standardized Motivation Composite"
  ) +
  theme_minimal()
```

This code visualizes the knowledge-motivation profiles for each cluster using a scatter plot with ellipses representing the 95% confidence regions for each cluster.

#### Cluster Validation Results

The plot shows distinct knowledge-motivation profiles for each cluster:

*   **Cluster 1:** Low knowledge, high motivation.
*   **Cluster 2:** High knowledge, high motivation.
*   **Cluster 3:** Average knowledge, average motivation.

## Correlation and Factor Analysis of Key Measures

```{r}
# Combine key measures into correlation matrix
key_measures <- combined_scores %>%
  select(
    # Knowledge measures
    numeracy, energy_use, energy_save, els_score,
    # Motivation/attitude measures
    env_attitude, perceived_difficulty, pol_conservatism
  ) %>%
  na.omit()

# Compute and visualize correlation matrix
cor_matrix <- cor(key_measures, use = "pairwise.complete.obs")
corrplot(cor_matrix,
  method = "color",
  type = "upper",
  addCoef.col = "black",
  tl.col = "black",
  tl.srt = 45,
  diag = FALSE,
  col = colorRampPalette(c("#6D9EC1", "white", "#E46726"))(200)
)
```

This code computes and visualizes the correlation matrix for the key knowledge and motivation measures.

### Correlation Matrix Visualization

The correlation plot shows the relationships between the key measures, with positive correlations in blue and negative correlations in red. The strength of the correlation is indicated by the intensity of the color and the size of the coefficient.

```{r}
# 2. Factor Analysis to examine underlying structure
fa_results <- fa(key_measures, nfactors = 2, rotate = "varimax")
print(fa_results, cut = 0.3, sort = TRUE)
```

This code performs a factor analysis on the key measures to examine the underlying structure.

### Factor Analysis Results

The factor analysis suggests a two-factor solution, with the knowledge measures loading on one factor and the motivation/attitude measures loading on the other factor. The perceived difficulty item loads negatively on the knowledge factor.


{{< pagebreak >}}

## Composite Scores and Relationships

```{r}
# Create composite scores for knowledge and motivation
combined_scores <- combined_scores %>%
  mutate(
    knowledge_composite = rowMeans(
      cbind(numeracy, energy_use, energy_save, els_score),
      na.rm = TRUE
    ),
    motivation_composite = rowMeans(
      cbind(env_attitude, -1 * perceived_difficulty),
      na.rm = TRUE
    )
  )

cluster_data <- combined_scores %>%
  select(knowledge_composite, motivation_composite) %>%
  na.omit() %>%
  scale()


# Determine the optimal number of clusters using the Elbow Method
fviz_nbclust(cluster_data, kmeans, method = "wss") +
  theme_minimal() +
  labs(title = "Elbow Method for Determining Optimal Number of Clusters")


# Decide the number of clusters (k). Let's try k = 3 for illustration:
set.seed(123)
km_fit <- kmeans(cluster_data, centers = 3, nstart = 25)
# Visualize clusters
fviz_cluster(km_fit, data = cluster_data) +
  labs(title = "K-means Clustering on Knowledge vs. Motivation - 3 clusters") +
  theme_minimal()

# Decide the number of clusters (k). Let's try k =4 for illustration:
set.seed(123)
km_fit <- kmeans(cluster_data, centers = 4, nstart = 25)
# Visualize clusters
fviz_cluster(km_fit, data = cluster_data) +
  labs(title = "K-means Clustering on Knowledge vs. Motivation -4 clusters") +
  theme_minimal()


```

This code creates composite scores for knowledge and motivation and then uses cluster analysis to identify distinct profiles based on these composite scores.

### Cluster Analysis Results

```{r}

# Add cluster membership back to your main dataframe
combined_scores$km_cluster <- factor(km_fit$cluster)

# Compare mean knowledge & motivation by cluster
combined_scores %>%
  group_by(km_cluster) %>%
  summarise(
    mean_knowledge = mean(knowledge_composite, na.rm = TRUE),
    mean_motivation = mean(motivation_composite, na.rm = TRUE),
    n = n()
  )
```


# Cluster Profiles

```{r}

# Add cluster membership to dataframe
combined_scores$cluster <- factor(km_fit$cluster)

# Summarize cluster profiles
cluster_profiles <- combined_scores %>%
  group_by(cluster) %>%
  summarise(
    n = n(),
    mean_knowledge = mean(knowledge_composite, na.rm=TRUE),
    sd_knowledge = sd(knowledge_composite, na.rm=TRUE),
    mean_motivation = mean(motivation_composite, na.rm=TRUE),
    sd_motivation = sd(motivation_composite, na.rm=TRUE)
  )

print(cluster_profiles)
```



{{< pagebreak >}}


# Clustering on question-level data

```{r}
#| fig-width: 10
#| fig-height: 8



# combine question level data (aes_combined, att2_combined, els, rs,) by id

dq <- aes_combined |> left_join(att2_combined, by = "id") |> left_join(els, by = "id") |> left_join(rs, by = "id")



# Custom function for correlation matrix plots of question-level data
plot_cor_matrix_items <- function(data, title = NULL) {
    
  cor_matrix <- cor(data, use = "pairwise.complete.obs")
  
  # Identify item types based on column names
  item_names <- colnames(cor_matrix)
  is_attari_diff <- grepl("^ATT0[1-9]$|^ATT1[0-5]$", item_names) # ATT01-ATT15
  is_attari_num <- grepl("^ATT1[6-8]$", item_names)  # ATT16-ATT18
  is_attari_energy_use <- grepl("^ATT(19|2[0-7])$", item_names) # ATT19-ATT27
  is_attari_energy_save <- grepl("^ATT(2[8-9]|3[0-3])$", item_names)  # ATT28-ATT33
  is_els <- grepl("^ELS0[1-8]$", item_names) # ELS01-ELS08
  is_rs <- grepl("^RS0[1-6]$", item_names) # RS01-RS06
  
  item_groups <- ifelse(is_attari_diff, "Attari Difficulty",
                       ifelse(is_attari_num, "Attari Numeracy",
                              ifelse(is_attari_energy_use, "Attari Usage",
                                     ifelse(is_attari_energy_save, "Attari Savings",
                                            ifelse(is_els, "Energy Literacy",
                                                   ifelse(is_rs, "Recycling Study", NA))))))
  
  qgraph(cor_matrix,
         layout = "spring",
         groups = list("Attari Difficulty" = which(item_groups == "Attari Difficulty"),
                       "Attari Numeracy" = which(item_groups == "Attari Numeracy"),
                       "Attari Usage" = which(item_groups == "Attari Usage"),
                       "Attari Savings" = which(item_groups == "Attari Savings"),
                       "Energy Literacy" = which(item_groups == "Energy Literacy"),
                       "Recycling Study" = which(item_groups == "Recycling Study")),
         color = c(rep("skyblue", sum(is_attari_diff)),
                   rep("lightcoral", sum(is_attari_num)),
                   rep("lightgreen", sum(is_attari_energy_use)),
                   rep("lightyellow", sum(is_attari_energy_save)),
                   rep("lightpink", sum(is_els)),
                    rep("lightcyan", sum(is_rs))),
         title = title)
  
}

plot_cor_matrix_items(dq |> select(-id))


```

```{r}
#| eval: false
#| include: false



r$> colnames(dq)
#  [1] "id"    "ATT01" "ATT02" "ATT03" "ATT04" "ATT05" "ATT06" "ATT07" "ATT08" "ATT09" "ATT10" "ATT11" "ATT12" "ATT13" "ATT14" "ATT15" "ATT16" "ATT17" "ATT18" "ATT19" "ATT20"
# [22] "ATT21" "ATT22" "ATT23" "ATT24" "ATT25" "ATT26" "ATT27" "ATT28" "ATT29" "ATT30" "ATT31" "ATT32" "ATT33" "ELS01" "ELS02" "ELS03" "ELS04" "ELS05" "ELS06" "ELS07" "ELS08"
# [43] "RS01"  "RS02"  "RS03"  "RS04"  "RS05"  "RS06" 

# sem model from dq

sem_model <- '
  Knowledge =~ ATT16 + ATT17 + ATT18 + ATT19 + ATT20 + ATT21 + ATT22 + ATT23 + ATT24 + ATT25 + ATT26 + ATT27 + ATT28 + ATT29 + ATT30 + ATT31 + ATT32 + ATT33 + ELS01 + ELS02 + ELS03 + ELS04 + ELS05 + ELS06 + ELS07 + ELS08
  Motivation =~ ATT01 + ATT02 + ATT03 + ATT04 + ATT05 + ATT06 + ATT07 + ATT08 + ATT09 + ATT10 + ATT11 + ATT12 + ATT13 + ATT14 + ATT15 + RS01 + RS02 + RS03 + RS04 + RS05 + RS06
  Knowledge ~ Motivation
'

sem_q <- sem(sem_model, data = dq, missing = "fiml")  # handle missing if needed
tidySEM::graph_sem(sem_q)
semPlot::semPaths(sem_q,layout="tree2",residual=TRUE,whatLabels="est", nCharNodes = 12)




# pca on dq
# cluster_data <- dq %>% # get mean of each column (exlude na)
#   select(-id) %>%
#   summarise(across(everything(), mean, na.rm = TRUE)) %>%
#     scale()




pca_result <- prcomp(cluster_data)



ate cluster visualization
p_clusters <- ggplot(cluster_df, aes(x = PC1, y = PC2)) +
  geom_point(aes(color = factor(dq$km_cluster)), alpha = 0.6) +
  theme_minimal() +
  labs(
    title = "Knowledge-Motivation Clusters",
    x = "First Principal Component",
    y = "Second Principal Component"
  )






plot_item_correlation_matrix <- function(data, knowledge_items, motivation_items, title = "Item-Level Correlation Matrix") {
  # Combine knowledge and motivation items
  all_items <- c(knowledge_items, motivation_items)

  # Create a named vector for item types
  item_types <- c(rep("Knowledge", length(knowledge_items)), rep("Motivation", length(motivation_items)))
  names(item_types) <- all_items

  # Select items and compute correlation matrix
  cor_matrix <- data %>%
    select(all_of(all_items)) %>%
    mutate_all(as.numeric) %>% # Convert all columns to numeric
    cor(use = "pairwise.complete.obs")

  # Create a color palette
  col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))

  # Create a vector of colors for the item labels based on type
  label_colors <- ifelse(item_types[rownames(cor_matrix)] == "Knowledge", "blue", "darkgreen")

  # Generate the correlation plot
  corrplot(cor_matrix,
    method = "color",
    type = "upper",
    order = "original", # Keep original variable order
    addCoef.col = "black",
    tl.col = label_colors, # Apply colors to labels based on the 'groups'
    tl.srt = 45,
    tl.cex = 0.7,
    diag = FALSE,
    col = col(200),
    title = title,
    mar = c(0, 0, 2, 0) # Adjust margin for title
  )
}


# Define knowledge and motivation items based on your survey structure
knowledge_items <- c(
  paste0("ATT", 16:18), # Numeracy
  paste0("ATT", 19:33), # Relative Energy Usage and Savings
  paste0("ELS0", 1:8) # Energy Literacy
)
motivation_items <- c(
  paste0("ATT0", 1:9), # Perceived Difficulty
  paste0("ATT", 10:15), # Perceived Difficulty
  paste0("RS0", 1:6) # Recycling Study (Attitudes/Motivation)
)

plot_item_correlation_matrix(dq |> select(-id), knowledge_items, motivation_items, title = "Item-Level Correlation Matrix: Knowledge vs. Motivation")




cluster_data <- dq %>%
  select(-id) %>%
  na.omit() %>%
  scale()


# Determine the optimal number of clusters using the Elbow Method
fviz_nbclust(cluster_data, kmeans, method = "wss") +
  theme_minimal() +
  labs(title = "Elbow Method for Determining Optimal Number of Clusters")


# Decide the number of clusters (k). Let's try k = 3 for illustration:
set.seed(123)
km_fit <- kmeans(cluster_data, centers = 4, nstart = 25)
# Visualize clusters
fviz_cluster(km_fit, data = cluster_data) +
  labs(title = "K-means Clustering on Knowledge vs. Motivation - 3 clusters") +
  theme_minimal()


# Add cluster membership back to your main dataframe
dq$km_cluster <- factor(km_fit$cluster)



colnames(dq)
#  [1] "id"         "ATT01"      "ATT02"      "ATT03"      "ATT04"      "ATT05"      "ATT06"      "ATT07"      "ATT08"      "ATT09"      "ATT10"      "ATT11"      "ATT12"     
# [14] "ATT13"      "ATT14"      "ATT15"      "ATT16"      "ATT17"      "ATT18"      "ATT19"      "ATT20"      "ATT21"      "ATT22"      "ATT23"      "ATT24"      "ATT25"     
# [27] "ATT26"      "ATT27"      "ATT28"      "ATT29"      "ATT30"      "ATT31"      "ATT32"      "ATT33"      "ELS01"      "ELS02"      "ELS03"      "ELS04"      "ELS05"     
# [40] "ELS06"      "ELS07"      "ELS08"      "RS01"       "RS02"       "RS03"       "RS04"       "RS05"       "RS06"       "km_cluster"

# aggregate and summarize the data - assess how clusters relate to knowledge vs. motivation items
dq |> 
  group_by(km_cluster) |> 
  summarise(
    n = n(),
    across(ATT01:ATT15, ~ mean(.x, na.rm = TRUE), .names = "mean_{.col}"),
    across(ATT16:ATT33, ~ mean(.x, na.rm = TRUE), .names = "mean_{.col}"),
    across(ELS01:ELS08, ~ mean(.x, na.rm = TRUE), .names = "mean_{.col}"),
    across(RS01:RS06,   ~ mean(.x, na.rm = TRUE), .names = "mean_{.col}")
  ) |>
  arrange(desc(n))




```